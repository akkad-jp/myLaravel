 # 環境構築メモ
 ## Laravel インストール
 ```
 curl -s "https://laravel.build/aihub-platform" | bash
 cd aihub-platform
 sail up -d
 ```
## PHPStan をインストール
```
sail composer --dev require nunomaduro/larastan
```
### phpstan.neon を作成する
```
includes:
  - ./vendor/nunomaduro/larastan/extension.neon

parameters:
  paths:
    - app

  level: 6
  # 0 ~ 9
  # see https://phpstan.org/user-guide/rule-levels

  checkGenericClassInNonGenericObjectType: false
  checkMissingIterableValueType: false
  treatPhpDocTypesAsCertain: false
```

## L5-Swagger のインストール
see https://github.com/DarkaOnLine/L5-Swagger

```
composer require "darkaonline/l5-swagger"
sail artisan vendor:publish --provider "L5Swagger\L5SwaggerServiceProvider"
```

## Vue3 のインストール
```
sail npm install @vitejs/plugin-vue --save-dev
```
app.blade.php
```
<!DOCTYPE html>
<html lang="{{ str_replace('_', '-', app()->getLocale()) }}">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
    @vite(['resources/css/app.css', 'resources/js/app.js'])
    @inertiaHead
  </head>
  <body>
    @inertia
  </body>
</html>
```

```
sail npm install dotenv --save-dev
```
Kernel.php
```
'web' => [
    // ...
    \App\Http\Middleware\HandleInertiaRequests::class,
],
```


## Inertia をインストールする
see https://inertiajs.com/server-side-setup
- Breeze をインストールすればInertia も一緒にインストールされるが、余計なリソースが大量にくっついてくるため、個別にインストールする。
### サーバーサイド
```
sail composer require inertiajs/inertia-laravel
sail artisan inertia:middleware
```

### vite.config.js を編集する
vite.config.js
```
import { defineConfig } from 'vite';
import laravel from 'laravel-vite-plugin';
import vue from '@vitejs/plugin-vue';

export default defineConfig({
    plugins: [
        vue(),
        laravel({
            input: ['resources/css/app.css', 'resources/js/app.js'],
            refresh: true,
        }),
    ],
});
```

### クライアントサイド
```
sail npm install @inertiajs/vue3
```
app.js
```
import { createApp, h } from 'vue'
import { createInertiaApp } from '@inertiajs/vue3'

createInertiaApp({
  resolve: name => {
    const pages = import.meta.glob('./Pages/**/*.vue', { eager: true })
    return pages[`./Pages/${name}.vue`]
  },
  setup({ el, App, props, plugin }) {
    createApp({ render: () => h(App, props) })
      .use(plugin)
      .mount(el)
  },
})
```


## Ziggy をインストールする
see https://github.com/tighten/ziggy
```
sail composer require tightenco/ziggy
sail artisan ziggy:generate
```
### 以下のファイルを適宜編集する
- resources/views/app.blade.php
- resources/js/app.js

app.blade.php には@route を<head>内に追記。  
app.js には「const route = window.route」を追記。

## ESLint をインストールする
```
sail npm install eslint --save-dev
sail npm install eslint-config-standard --save-dev
```

### 初期設定
```
./node_modules/.bin/eslint --init
<< 環境に合わせて質問に答える >>
```

### 以下のファイルを編集する
- .eslintrc.yml
- package.json

eslintrc.yml
```
env:
  browser: true
  es2021: true
  node: true
extends:
  - eslint:recommended
  - plugin:vue/vue3-essential
parserOptions:
  ecmaVersion: latest
  sourceType: module
  requireConfigFile: false
plugins:
  - vue
rules: {
  vue/multi-word-component-names: warn
}
```

package.json
```
    "scripts": {
        "dev": "vite",
        "build": "vite build",
        "lint": "npx eslint --ext .vue,.js resources/js",
        "lint-fix": "npm run lint -- --fix"
    },
```

## Auth0 対応
see https://auth0.com/docs
see https://auth0.com/docs/quickstart/webapp/laravel/interactive

### SDKインストール
```
sail composer require auth0/login:^7.8 --update-with-all-dependencies
```
設定ファイルを生成する
```
sail artisan vendor:publish --tag auth0
```
### SDK設定
- .auth0.api.json が用意できている場合は、この手順は不要。
Auth0 CLIをダウンロードする
```
mkdir dev
curl -sSfL https://raw.githubusercontent.com/auth0/auth0-cli/main/install.sh | sh -s -- -b ./dev/
```

### Auth0 CLI を使って、Auth0上にアプリケーションとAPI を作成する。
- .auth0.api.json が用意できている場合は、この手順は不要。
```
dev/initAuth0/createApp.sh
dev/initAuth0/createApi.sh

echo ".auth0.*.json" >> .gitignore
```

### ユーザリポジトリの作成
see https://github.com/auth0/laravel-auth0/blob/main/docs/Users.md
  
デフォルトでは、SDK はアプリケーションのデータベースにユーザー情報を保存しない。代わりに、セッションを使用してユーザーの ID トークンを保存し、必要に応じてトークンからユーザー情報を取得する。  
ユーザ情報に独自の項目を追加し、DBに保存するためにリポジトリパターンを用いてこれを実装する。  
（ユーザ情報に独自の項目を追加するだけなら、Auth0 の機能だけで実現できる。今回はCasher/Stripe でApp\Models\User の使用が必要となるため、以下の手順を実行する）
app\Repositories\UserRepository.php を作成する

### Auth0 でEloquent を使用する準備
see https://github.com/auth0/laravel-auth0/blob/main/docs/Eloquent.md

#### migration ファイル作成
```
php artisan make:migration update_users_table --table=users
```
```
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        if (!Schema::hasColumn('users', 'auth0')) {
            Schema::table('users', function (Blueprint $table) {
                $table->string('auth0', 32)->nullabe();
                $table->boolean('email_verified')->default(false);

                $table->unique('auth0', 'users_auth0_unique');
            });
        }
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::table('users', function (Blueprint $table) {
            if (Schema::hasColumn('users', 'auth0')) {
                $table->dropUnique('users_auth0_unique');
                $table->dropColumn('auth0');
            }
            if (Schema::hasColumn('users', 'email_verified')) {
                $table->dropColumn('email_verified');
            }
        });
    }
};
```
app/Models/Users.php も上記内容に合わせて更新すること。

/app/Repositories/UserRepository.php
```
<?php

declare(strict_types=1);

namespace App\Repositories;

use App\Models\User;
use Auth0\Laravel\Users\{StatefulUser, StatelessUser};
use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Support\Facades\Cache;
use Illuminate\Support\Facades\Hash;
use Illuminate\Support\Str;

final class UserRepository extends UserRepositoryAbstract implements UserRepositoryContract
{
    public function fromAccessToken(array $user): ?Authenticatable
    {
        // return new StatelessUser($user);

        /*
        $user = [ // Example of a decoded access token
            "iss"   => "https://example.auth0.com/",
            "aud"   => "https://api.example.com/calendar/v1/",
            "sub"   => "auth0|123456",
            "exp"   => 1458872196,
            "iat"   => 1458785796,
            "scope" => "read write",
        ];
        */
        $identifier = $user['sub'] ?? $user['auth0'] ?? null;
        if (is_null($identifier)) {
            return null;
        }
        return User::where('auth0', $identifier)->first();
    }

    public function fromSession(array $user): ?Authenticatable
    {
        // return new StatefulUser($user);

        /*
        $user = [ // Example of a decoded ID token
            "iss"         => "http://example.auth0.com",
            "aud"         => "client_id",
            "sub"         => "auth0|123456",
            "exp"         => 1458872196,
            "iat"         => 1458785796,
            "name"        => "Jane Doe",
            "email"       => "janedoe@example.com",
        ];
        */
        $identifier = $user['sub'] ?? $user['auth0'] ?? null;
        $verified = in_array($user['email_verified'], [1, true], true);

        $profile = [
            'auth0' => $identifier,
            'name' => $user['name'] ?? '',
            'email' => $user['email'] ?? '',
            'email_verified' => $verified,
        ];

        $cacheKey = "auth0_user_{$identifier}";
        $cached = $this->withoutRecording(fn () => Cache::get($cacheKey));
        if ($cached) {
            return $cached;
        }

        $user = null;
        if (is_null($identifier)) {
            $user = User::where('auth0', $identifier)->first();
        }

        if (is_null($user) && isset($user['email'])) {
            $user = User::where('email', $user['email'])->first();
        }

        if (!is_null($user)) {
            $updates = [];

            $keys = [
                'auth0',
                'name',
                'email',
            ];
            foreach ($keys as $key) {
                if ($user[$key] !== $profile[$key]) {
                    $user[$key] = $profile[$key];
                }
            }

            $verified = in_array($user->email_verified, [1, true], true);
            if ($verified !== $profile['email_verified']) {
                $updates['email_verified'] = $profile['email_verified'];
            }

            if (count($updates) > 0) {
                $user->update($updates);
                $user->save();
            } else if (!is_null($cached)) {
                return $user;
            }
        }
        if (is_null($user)) {
            // ダミー値をパスワードに登録する
            $profile['password'] = Hash::make(Str::random(32));
            $user = User::create($profile);
        }
        // キャッシュ30秒間
        $this->withoutRecording(fn () => Cache::put($cacheKey, $user, 30));

        return $user;
    }

    /**
     * Workaround for Laravel Telescope potentially causing an infinite loop.
     * @link https://github.com/auth0/laravel-auth0/tree/main/docs/Telescope.md
     *
     * @param callable $callback
     */
    private function withoutRecording($callback): mixed
    {
        $telescope = '\Laravel\Telescope\Telescope';

        if (class_exists($telescope)) {
            return "$telescope"::withoutRecording($callback);
        }

        return call_user_func($callback);
    }
}

```

### 作成したリポジトリを登録する
config/auth.php
```
'providers' => [
  'auth0-provider' => [
    'driver' => 'auth0.provider',
    'repository' => \App\Repositories\UserRepository::class,
  ],
],
```

## TailwindCSS をインストールする
see https://tailwindcss.com/docs/installation
```
sail npm install tailwindcss --save-dev
sail npx tailwindcss init
```
### 設定関連のファイルを編集する
tailwind.config.js
```
/** @type {import('tailwindcss').Config} */
export default {
  content: [],
  theme: {
    extend: {},
  },
  plugins: [],
}

module.exports = {
  content: [
    "./resources/**/*.blade.php",
    "./resources/**/*.js",
    "./resources/**/*.vue",
  ],
  theme: {
    extend: {},
  },
  plugins: [],
}
```

resources/css/app.css
```
@tailwind base;
@tailwind components;
@tailwind utilities;
```

vite.config.js
```
import { defineConfig } from 'vite';
import laravel from 'laravel-vite-plugin';
import vue from '@vitejs/plugin-vue';
import tailwindcss from 'tailwindcss';

export default defineConfig({
    plugins: [
        laravel({
            input: ['resources/css/app.css', 'resources/js/app.js'],
            refresh: true,
        }),
        vue(),
    ],
    css: {
        postcss: {
            plugins: [
                tailwindcss(),
            ]
        }
    }
});
```

## Laravel Cashier Stripe をインストールする
see https://readouble.com/laravel/10.x/ja/billing.html

```
composer require laravel/cashier
sail artisan vendor:publish --tag="cashier-migrations"
sail artisan migrate
```

### .env に追記
```
# Stripe
STRIPE_KEY=your-stripe-key
STRIPE_SECRET=your-stripe-secret
STRIPE_WEBHOOK_SECRET=
```
STRIPE_KEYとSTRIPE_SECRETはStripeダッシュボード > 開発者　> APIキーから取得。  
STRIPE_WEBHOOK_SECRET は以降の手順で取得する。

### Webフックの処理の設定
see https://readouble.com/laravel/10.x/ja/billing.html#handling-stripe-webhooks  

#### Docker 環境内にStripe CLI をインストールする
```
sail exec -it laravel.app bash

curl -s https://packages.stripe.dev/api/security/keypair/stripe-cli-gpg/public | gpg --dearmor | tee /usr/share/keyrings/stripe.gpg

echo "deb [signed-by=/usr/share/keyrings/stripe.gpg] https://packages.stripe.dev/stripe-cli-debian-local stable main" | tee -a /etc/apt/sources.list.d/stripe.list

apt-get update
apt-get install stripe
```

#### アクセスを許可する
```
stripe login
```
表示されるURLにブラウザでアクセスして認証を受け、WebHook のアクセスを許可する。

```
stripe listen --forward-to 127.0.0.1:8000/stripe/webhook
```
表示される whsec_XXXXX... の部分がwebhook_secret。
.env のSTRIPE_WEBHOOK_SECRET に記載する。



```
sail artisan cashier:webhook
```
### APIキーを登録する
